name: LeetCode Metrics

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  metrics:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate LeetCode metrics (no auto-commit)
        uses: lowlighter/metrics@latest
        with:
          filename: metrics.plugin.leetcode.svg
          token: ${{ secrets.GITHUB_TOKEN }}
          base: ""
          output_action: none

          plugin_leetcode: yes
          plugin_leetcode_user: hereisben
          plugin_leetcode_sections: solved, skills, recent

      - name: Patch SVG (fix cropping + add border/bg)
        run: |
          python - <<'PY'
          import re, pathlib

          p = pathlib.Path("metrics.plugin.leetcode.svg")
          s = p.read_text(encoding="utf-8")

          target_h = 325

          # 0) Fix broken foreignObject height
          s = re.sub(
            r'(<foreignObject[^>]*\bheight=")[^"]*(")\s*\)?',
            rf'\g<1>{target_h}\2',
            s,
            count=1
          )

          # 1) Force <svg> height
          s = re.sub(r'(<svg[^>]*\bheight=")\d+(")', rf'\g<1>{target_h}\2', s, count=1)

          # 2) Remove duplicated injected css (keep only 1)
          css_sig = r'<style>svg\{color:#c9d1d9\} h2\{color:#ffffff\} \.label\{background-color:#58a6ff30;color:#c9d1d9\}</style>'
          parts = re.split(css_sig, s)
          if len(parts) > 2:
            # keep first occurrence only
            s = parts[0] + re.search(css_sig, s).group(0) + "".join(parts[1:])

          # 3) Ensure exactly one rect background/border
          # remove old rects we injected
          s = re.sub(r'\s*<rect[^>]*fill="#0d1117"[^>]*stroke="#30363d"[^>]*/>\s*', "\n", s)
          rect = f'<rect x="0" y="0" width="100%" height="{target_h}" rx="10" ry="10" fill="#0d1117" stroke="#30363d" stroke-width="1"/>'
          s = re.sub(r'(<svg[^>]*>)', r'\1\n  ' + rect, s, count=1)

          # 4) Ensure css exists inside defs once
          css = '<style>svg{color:#c9d1d9} h2{color:#ffffff} .label{background-color:#58a6ff30;color:#c9d1d9}</style>'
          if "<defs>" in s and css not in s:
            s = s.replace("<defs>", "<defs>\n" + css + "\n", 1)

          p.write_text(s, encoding="utf-8")
          print("patched ok")
          PY

      - name: Commit updated svg
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update leetcode metrics"
